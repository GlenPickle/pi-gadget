#!/bin/sh -e

PREREQS=""

prereqs() { echo "$PREREQS"; }

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

FSROOT="/root/writable/system-data"
SYSTEMDDIR="${FSROOT}/etc/systemd"
JOBDIR="${SYSTEMDDIR}/system"

if grep -q nosubiquity /proc/cmdline; then
        if [ ! -e "${FSROOT}/var/lib/console-conf/complete" ]; then
                mkdir -p "${FSROOT}/var/lib/console-conf" || true
                touch "${FSROOT}/var/lib/console-conf/complete" || true
        fi
fi

SERVICENAME="getty@tty1.service"
if ! grep -q " nogetty " /proc/cmdline; then
    [ -d "${JOBDIR}/getty.target.wants" ] || mkdir -p "${JOBDIR}/getty.target.wants"
    [ -e "${JOBDIR}/getty.target.wants/${SERVICENAME}" ] || ln -s /dev/null "${JOBDIR}/getty.target.wants/${SERVICENAME}"
else
    rm -f "${JOBDIR}/getty.target.wants/${SERVICENAME}" || true
fi

SERVICENAME="end.psplash.service"
if [ ! -e "${JOBDIR}/${SERVICENAME}" ]; then
       cp "/scripts/init-bottom/${SERVICENAME}" "${JOBDIR}/${SERVICENAME}" || true
       ln -s "/etc/systemd/system/${SERVICENAME}" "${JOBDIR}/multi-user.target.wants/${SERVICENAME}" || true
fi
