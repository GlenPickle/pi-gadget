#!/bin/sh -e

PREREQS=""

prereqs() { echo "$PREREQS"; }

case "$1" in
    prereqs)
    prereqs
    exit 0
    ;;
esac

FSROOT="/root/writable/system-data"
SYSTEMDDIR="${FSROOT}/etc/systemd"
JOBDIR="${SYSTEMDDIR}/system"

if grep -q nosubiquity /proc/cmdline; then
        if [ ! -e "${FSROOT}/var/lib/console-conf/complete" ]; then
                mkdir -p "${FSROOT}/var/lib/console-conf" || true
                touch "${FSROOT}/var/lib/console-conf/complete" || true
        fi
fi

if grep -q nogetty /proc/cmdline; then
    [ -d "${JOBDIR}/getty.target.wants" ] || mkdir -p "${JOBDIR}/getty.target.wants"
    for i in 1 2 3 4 5 6; do
        ln -sf /dev/null ${JOBDIR}/getty.target.wants/getty\@tty${i}.service || true
    done
else
    ln -sf /lib/systemd/system/getty@.service ${JOBDIR}/getty.target.wants/getty\@tty1.service || true
fi

SERVICENAME="end.psplash.service"
if [ ! -e "${JOBDIR}/${SERVICENAME}" ]; then
       [ -d "${JOBDIR}/multi-user.target.wants" ] || mkdir -p "${JOBDIR}/multi-user.target.wants"
       cp "/scripts/init-bottom/${SERVICENAME}" "${JOBDIR}/${SERVICENAME}" || true
       ln -sif "/etc/systemd/system/${SERVICENAME}" "${JOBDIR}/multi-user.target.wants/${SERVICENAME}" || true
fi
